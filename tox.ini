# ======================================================================
# Phenoteka — tox.ini
# ======================================================================
# Purpose:
#   tox orchestrates Phenoteka’s local and CI task matrix:
#     • run tests across supported Python versions
#     • enforce style & lint rules
#     • run static typing
#     • build documentation
#     • optional: build/package sanity checks and cleanup
#
# Design notes:
#   • Uses the modern `src/` layout (package lives in src/phenoteka).
#   • Reuses extras from pyproject.toml (e.g., .[test], .[dev], .[docs]).
#   • Keeps environments composable and explicit for clarity in CI logs.
#   • Aggressively comments each section for educational transparency.
# ======================================================================

# ======================================================================
# Phenoteka — tox.ini (tox 4+)
# ======================================================================

[tox]
requires = tox>=4.8
env_list = py312, py311, type, lint, format

[pytest]
# (pytest options live in pyproject.toml already; this section is optional)

# ----------------------------------------------------------------------
# Default test environment (runs unit tests)
# ----------------------------------------------------------------------
[testenv]
description = Run test suite with pytest
package = editable
# If you have extras in pyproject like: [project.optional-dependencies] test = ["pytest", "pytest-cov", ...]
# tox will install them when listed here:
extras = test
setenv =
    # If you need the src layout on PYTHONPATH (pytest finds the installed dist, so this is often unnecessary)
    # PYTHONPATH = {toxinidir}/src
passenv =
    # Pass through CI vars or credentials if you need them
    CI
commands =
    python -m pip --version
    pytest {posargs}

# ----------------------------------------------------------------------
# Linting (static style checks)
# ----------------------------------------------------------------------
[testenv:lint]
description = Ruff (lint) against the codebase
skip_install = true
deps =
    ruff>=0.4
commands =
    ruff version
    ruff check --output-format=full .

# ----------------------------------------------------------------------
# Formatting (apply import/style fixes)
# ----------------------------------------------------------------------
[testenv:format]
description = Apply import/order fixes with Ruff and code formatting with Black
skip_install = true
deps =
    ruff>=0.4
    black>=24.3
commands =
    ruff check --select I --fix .
    black .

# ----------------------------------------------------------------------
# Static typing
# ----------------------------------------------------------------------
[testenv:type]
description = Type-check with mypy
package = editable
deps =
    mypy>=1.10
    # If you ship type stubs for numpy/pandas, add them here:
    types-PyYAML
    # mypy plugins as needed:
    # pandas-stubs
commands =
    mypy --version
    mypy src/phenoteka

# ----------------------------------------------------------------------
# (Optional) Docs build (sphinx, mkdocs, pdoc, etc.)
# ----------------------------------------------------------------------
[testenv:docs]
description = Build docs (optional)
skip_install = false
deps =
    # add your doc toolchain here, e.g.:
    # sphinx
    # furo
commands =
    python -c "print('Docs env not configured yet. Add sphinx and a build command here.')"

# ----------------------------------------------------------------------
# Cleanup helpers
# ----------------------------------------------------------------------
[testenv:clean]
description = Remove build, dist, and coverage artifacts
skip_install = true
allowlist_externals = bash
commands =
    bash -c "rm -rf .tox .pytest_cache .mypy_cache dist build htmlcov coverage.xml docs/build"
    bash -c "find . -name '*.pyc' -delete"
    bash -c "find . -name '__pycache__' -type d -prune -exec rm -rf {} +"

# ----------------------------------------------------------------------
# Notes:
#  • Use `tox -e format` once before committing to auto-apply styling.
#  • CI typically runs: `tox -q -s false` which will iterate envlist.
#  • Add more matrix envs (e.g., db, api) later if you want integration tests.
# ----------------------------------------------------------------------